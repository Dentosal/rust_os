name: CI
on:
  push:
    paths-ignore:
      - 'docs/**'
      - 'dbgenv_config/**'
      - '**.md'
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - run: sudo apt-get update && sudo apt-get install -y nasm binutils

      - name: Install latest nightly
        uses: actions-rs/toolchain@v1
        with:
            toolchain: nightly
            override: true
            components: rustfmt, clippy, rust-src

      - name: Install tooling
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --check

      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - run: pip install toml natsort

      - name: Clone factory
        uses: actions/checkout@v2
        with:
          repository: Dentosal/factory
          path: ./factory

      - uses: actions/cache@v2
        id: cache-factory
        with:
          path: ~/.cargo/bin/factory
          key: ${{ hashFiles('./factory/Cargo.toml') }}-${{ hashFiles('./factory/src/**') }}

      - name: Build factory
        if: steps.cache-factory.outputs.cache-hit != 'true'
        working-directory: ./factory
        run: cargo install --path . --force

      - name: Clone constcodegen
        uses: actions/checkout@v2
        with:
          repository: Dentosal/constcodegen
          path: ./constcodegen

      - uses: actions/cache@v2
        id: cache-constcodegen
        with:
          path: ~/.cargo/bin/constcodegen
          key: ${{ hashFiles('./constcodegen/Cargo.toml') }}-${{ hashFiles('./constcodegen/src/**') }}

      - name: Build constcodegen
        if: steps.cache-constcodegen.outputs.cache-hit != 'true'
        working-directory: ./constcodegen
        run: cargo install --path . --force

      - run: factory

      - name: Run cargo fmt --check
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --check

      - name: Run cargo clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
